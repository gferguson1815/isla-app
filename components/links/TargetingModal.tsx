'use client';

import React, { useState, useEffect, useRef } from 'react';
import { X, MapPin, Smartphone, Crown, Plus, ChevronDown, HelpCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useFeatureGate } from '@/hooks/useFeatureGate';
import { useRouter } from 'next/navigation';
import { useParams } from 'next/navigation';

// Country list with codes - United States first, then alphabetical
const COUNTRIES = [
  { code: 'US', name: 'United States', flag: 'ğŸ‡ºğŸ‡¸' },
  { code: 'AF', name: 'Afghanistan', flag: 'ğŸ‡¦ğŸ‡«' },
  { code: 'AX', name: 'Ã…land Islands', flag: 'ğŸ‡¦ğŸ‡½' },
  { code: 'AL', name: 'Albania', flag: 'ğŸ‡¦ğŸ‡±' },
  { code: 'DZ', name: 'Algeria', flag: 'ğŸ‡©ğŸ‡¿' },
  { code: 'AS', name: 'American Samoa', flag: 'ğŸ‡¦ğŸ‡¸' },
  { code: 'AD', name: 'Andorra', flag: 'ğŸ‡¦ğŸ‡©' },
  { code: 'AO', name: 'Angola', flag: 'ğŸ‡¦ğŸ‡´' },
  { code: 'AI', name: 'Anguilla', flag: 'ğŸ‡¦ğŸ‡®' },
  { code: 'AQ', name: 'Antarctica', flag: 'ğŸ‡¦ğŸ‡¶' },
  { code: 'AG', name: 'Antigua and Barbuda', flag: 'ğŸ‡¦ğŸ‡¬' },
  { code: 'AR', name: 'Argentina', flag: 'ğŸ‡¦ğŸ‡·' },
  { code: 'AM', name: 'Armenia', flag: 'ğŸ‡¦ğŸ‡²' },
  { code: 'AW', name: 'Aruba', flag: 'ğŸ‡¦ğŸ‡¼' },
  { code: 'AU', name: 'Australia', flag: 'ğŸ‡¦ğŸ‡º' },
  { code: 'AT', name: 'Austria', flag: 'ğŸ‡¦ğŸ‡¹' },
  { code: 'AZ', name: 'Azerbaijan', flag: 'ğŸ‡¦ğŸ‡¿' },
  { code: 'BS', name: 'Bahamas', flag: 'ğŸ‡§ğŸ‡¸' },
  { code: 'BH', name: 'Bahrain', flag: 'ğŸ‡§ğŸ‡­' },
  { code: 'BD', name: 'Bangladesh', flag: 'ğŸ‡§ğŸ‡©' },
  { code: 'BB', name: 'Barbados', flag: 'ğŸ‡§ğŸ‡§' },
  { code: 'BY', name: 'Belarus', flag: 'ğŸ‡§ğŸ‡¾' },
  { code: 'BE', name: 'Belgium', flag: 'ğŸ‡§ğŸ‡ª' },
  { code: 'BZ', name: 'Belize', flag: 'ğŸ‡§ğŸ‡¿' },
  { code: 'BJ', name: 'Benin', flag: 'ğŸ‡§ğŸ‡¯' },
  { code: 'BM', name: 'Bermuda', flag: 'ğŸ‡§ğŸ‡²' },
  { code: 'BT', name: 'Bhutan', flag: 'ğŸ‡§ğŸ‡¹' },
  { code: 'BO', name: 'Bolivia', flag: 'ğŸ‡§ğŸ‡´' },
  { code: 'BA', name: 'Bosnia and Herzegovina', flag: 'ğŸ‡§ğŸ‡¦' },
  { code: 'BW', name: 'Botswana', flag: 'ğŸ‡§ğŸ‡¼' },
  { code: 'BV', name: 'Bouvet Island', flag: 'ğŸ‡§ğŸ‡»' },
  { code: 'BR', name: 'Brazil', flag: 'ğŸ‡§ğŸ‡·' },
  { code: 'IO', name: 'British Indian Ocean Territory', flag: 'ğŸ‡®ğŸ‡´' },
  { code: 'VG', name: 'British Virgin Islands', flag: 'ğŸ‡»ğŸ‡¬' },
  { code: 'BN', name: 'Brunei', flag: 'ğŸ‡§ğŸ‡³' },
  { code: 'BG', name: 'Bulgaria', flag: 'ğŸ‡§ğŸ‡¬' },
  { code: 'BF', name: 'Burkina Faso', flag: 'ğŸ‡§ğŸ‡«' },
  { code: 'BI', name: 'Burundi', flag: 'ğŸ‡§ğŸ‡®' },
  { code: 'KH', name: 'Cambodia', flag: 'ğŸ‡°ğŸ‡­' },
  { code: 'CM', name: 'Cameroon', flag: 'ğŸ‡¨ğŸ‡²' },
  { code: 'CA', name: 'Canada', flag: 'ğŸ‡¨ğŸ‡¦' },
  { code: 'CV', name: 'Cape Verde', flag: 'ğŸ‡¨ğŸ‡»' },
  { code: 'KY', name: 'Cayman Islands', flag: 'ğŸ‡°ğŸ‡¾' },
  { code: 'CF', name: 'Central African Republic', flag: 'ğŸ‡¨ğŸ‡«' },
  { code: 'TD', name: 'Chad', flag: 'ğŸ‡¹ğŸ‡©' },
  { code: 'CL', name: 'Chile', flag: 'ğŸ‡¨ğŸ‡±' },
  { code: 'CN', name: 'China', flag: 'ğŸ‡¨ğŸ‡³' },
  { code: 'CX', name: 'Christmas Island', flag: 'ğŸ‡¨ğŸ‡½' },
  { code: 'CC', name: 'Cocos (Keeling) Islands', flag: 'ğŸ‡¨ğŸ‡¨' },
  { code: 'CO', name: 'Colombia', flag: 'ğŸ‡¨ğŸ‡´' },
  { code: 'KM', name: 'Comoros', flag: 'ğŸ‡°ğŸ‡²' },
  { code: 'CG', name: 'Congo', flag: 'ğŸ‡¨ğŸ‡¬' },
  { code: 'CD', name: 'Congo (DRC)', flag: 'ğŸ‡¨ğŸ‡©' },
  { code: 'CK', name: 'Cook Islands', flag: 'ğŸ‡¨ğŸ‡°' },
  { code: 'CR', name: 'Costa Rica', flag: 'ğŸ‡¨ğŸ‡·' },
  { code: 'CI', name: 'CÃ´te d\'Ivoire', flag: 'ğŸ‡¨ğŸ‡®' },
  { code: 'HR', name: 'Croatia', flag: 'ğŸ‡­ğŸ‡·' },
  { code: 'CU', name: 'Cuba', flag: 'ğŸ‡¨ğŸ‡º' },
  { code: 'CW', name: 'CuraÃ§ao', flag: 'ğŸ‡¨ğŸ‡¼' },
  { code: 'CY', name: 'Cyprus', flag: 'ğŸ‡¨ğŸ‡¾' },
  { code: 'CZ', name: 'Czech Republic', flag: 'ğŸ‡¨ğŸ‡¿' },
  { code: 'DK', name: 'Denmark', flag: 'ğŸ‡©ğŸ‡°' },
  { code: 'DJ', name: 'Djibouti', flag: 'ğŸ‡©ğŸ‡¯' },
  { code: 'DM', name: 'Dominica', flag: 'ğŸ‡©ğŸ‡²' },
  { code: 'DO', name: 'Dominican Republic', flag: 'ğŸ‡©ğŸ‡´' },
  { code: 'EC', name: 'Ecuador', flag: 'ğŸ‡ªğŸ‡¨' },
  { code: 'EG', name: 'Egypt', flag: 'ğŸ‡ªğŸ‡¬' },
  { code: 'SV', name: 'El Salvador', flag: 'ğŸ‡¸ğŸ‡»' },
  { code: 'GQ', name: 'Equatorial Guinea', flag: 'ğŸ‡¬ğŸ‡¶' },
  { code: 'ER', name: 'Eritrea', flag: 'ğŸ‡ªğŸ‡·' },
  { code: 'EE', name: 'Estonia', flag: 'ğŸ‡ªğŸ‡ª' },
  { code: 'SZ', name: 'Eswatini', flag: 'ğŸ‡¸ğŸ‡¿' },
  { code: 'ET', name: 'Ethiopia', flag: 'ğŸ‡ªğŸ‡¹' },
  { code: 'FK', name: 'Falkland Islands', flag: 'ğŸ‡«ğŸ‡°' },
  { code: 'FO', name: 'Faroe Islands', flag: 'ğŸ‡«ğŸ‡´' },
  { code: 'FJ', name: 'Fiji', flag: 'ğŸ‡«ğŸ‡¯' },
  { code: 'FI', name: 'Finland', flag: 'ğŸ‡«ğŸ‡®' },
  { code: 'FR', name: 'France', flag: 'ğŸ‡«ğŸ‡·' },
  { code: 'GF', name: 'French Guiana', flag: 'ğŸ‡¬ğŸ‡«' },
  { code: 'PF', name: 'French Polynesia', flag: 'ğŸ‡µğŸ‡«' },
  { code: 'TF', name: 'French Southern Territories', flag: 'ğŸ‡¹ğŸ‡«' },
  { code: 'GA', name: 'Gabon', flag: 'ğŸ‡¬ğŸ‡¦' },
  { code: 'GM', name: 'Gambia', flag: 'ğŸ‡¬ğŸ‡²' },
  { code: 'GE', name: 'Georgia', flag: 'ğŸ‡¬ğŸ‡ª' },
  { code: 'DE', name: 'Germany', flag: 'ğŸ‡©ğŸ‡ª' },
  { code: 'GH', name: 'Ghana', flag: 'ğŸ‡¬ğŸ‡­' },
  { code: 'GI', name: 'Gibraltar', flag: 'ğŸ‡¬ğŸ‡®' },
  { code: 'GR', name: 'Greece', flag: 'ğŸ‡¬ğŸ‡·' },
  { code: 'GL', name: 'Greenland', flag: 'ğŸ‡¬ğŸ‡±' },
  { code: 'GD', name: 'Grenada', flag: 'ğŸ‡¬ğŸ‡©' },
  { code: 'GT', name: 'Guatemala', flag: 'ğŸ‡¬ğŸ‡¹' },
  { code: 'GG', name: 'Guernsey', flag: 'ğŸ‡¬ğŸ‡¬' },
  { code: 'GN', name: 'Guinea', flag: 'ğŸ‡¬ğŸ‡³' },
  { code: 'GW', name: 'Guinea-Bissau', flag: 'ğŸ‡¬ğŸ‡¼' },
  { code: 'GY', name: 'Guyana', flag: 'ğŸ‡¬ğŸ‡¾' },
  { code: 'HT', name: 'Haiti', flag: 'ğŸ‡­ğŸ‡¹' },
  { code: 'HM', name: 'Heard Island and McDonald Islands', flag: 'ğŸ‡­ğŸ‡²' },
  { code: 'HN', name: 'Honduras', flag: 'ğŸ‡­ğŸ‡³' },
  { code: 'HK', name: 'Hong Kong', flag: 'ğŸ‡­ğŸ‡°' },
  { code: 'HU', name: 'Hungary', flag: 'ğŸ‡­ğŸ‡º' },
  { code: 'IS', name: 'Iceland', flag: 'ğŸ‡®ğŸ‡¸' },
  { code: 'IN', name: 'India', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'ID', name: 'Indonesia', flag: 'ğŸ‡®ğŸ‡©' },
  { code: 'IR', name: 'Iran', flag: 'ğŸ‡®ğŸ‡·' },
  { code: 'IQ', name: 'Iraq', flag: 'ğŸ‡®ğŸ‡¶' },
  { code: 'IE', name: 'Ireland', flag: 'ğŸ‡®ğŸ‡ª' },
  { code: 'IM', name: 'Isle of Man', flag: 'ğŸ‡®ğŸ‡²' },
  { code: 'IL', name: 'Israel', flag: 'ğŸ‡®ğŸ‡±' },
  { code: 'IT', name: 'Italy', flag: 'ğŸ‡®ğŸ‡¹' },
  { code: 'JM', name: 'Jamaica', flag: 'ğŸ‡¯ğŸ‡²' },
  { code: 'JP', name: 'Japan', flag: 'ğŸ‡¯ğŸ‡µ' },
  { code: 'JE', name: 'Jersey', flag: 'ğŸ‡¯ğŸ‡ª' },
  { code: 'JO', name: 'Jordan', flag: 'ğŸ‡¯ğŸ‡´' },
  { code: 'KZ', name: 'Kazakhstan', flag: 'ğŸ‡°ğŸ‡¿' },
  { code: 'KE', name: 'Kenya', flag: 'ğŸ‡°ğŸ‡ª' },
  { code: 'KI', name: 'Kiribati', flag: 'ğŸ‡°ğŸ‡®' },
  { code: 'KP', name: 'North Korea', flag: 'ğŸ‡°ğŸ‡µ' },
  { code: 'KR', name: 'South Korea', flag: 'ğŸ‡°ğŸ‡·' },
  { code: 'XK', name: 'Kosovo', flag: 'ğŸ‡½ğŸ‡°' },
  { code: 'KW', name: 'Kuwait', flag: 'ğŸ‡°ğŸ‡¼' },
  { code: 'KG', name: 'Kyrgyzstan', flag: 'ğŸ‡°ğŸ‡¬' },
  { code: 'LA', name: 'Laos', flag: 'ğŸ‡±ğŸ‡¦' },
  { code: 'LV', name: 'Latvia', flag: 'ğŸ‡±ğŸ‡»' },
  { code: 'LB', name: 'Lebanon', flag: 'ğŸ‡±ğŸ‡§' },
  { code: 'LS', name: 'Lesotho', flag: 'ğŸ‡±ğŸ‡¸' },
  { code: 'LR', name: 'Liberia', flag: 'ğŸ‡±ğŸ‡·' },
  { code: 'LY', name: 'Libya', flag: 'ğŸ‡±ğŸ‡¾' },
  { code: 'LI', name: 'Liechtenstein', flag: 'ğŸ‡±ğŸ‡®' },
  { code: 'LT', name: 'Lithuania', flag: 'ğŸ‡±ğŸ‡¹' },
  { code: 'LU', name: 'Luxembourg', flag: 'ğŸ‡±ğŸ‡º' },
  { code: 'MO', name: 'Macau', flag: 'ğŸ‡²ğŸ‡´' },
  { code: 'MG', name: 'Madagascar', flag: 'ğŸ‡²ğŸ‡¬' },
  { code: 'MW', name: 'Malawi', flag: 'ğŸ‡²ğŸ‡¼' },
  { code: 'MY', name: 'Malaysia', flag: 'ğŸ‡²ğŸ‡¾' },
  { code: 'MV', name: 'Maldives', flag: 'ğŸ‡²ğŸ‡»' },
  { code: 'ML', name: 'Mali', flag: 'ğŸ‡²ğŸ‡±' },
  { code: 'MT', name: 'Malta', flag: 'ğŸ‡²ğŸ‡¹' },
  { code: 'MH', name: 'Marshall Islands', flag: 'ğŸ‡²ğŸ‡­' },
  { code: 'MR', name: 'Mauritania', flag: 'ğŸ‡²ğŸ‡·' },
  { code: 'MU', name: 'Mauritius', flag: 'ğŸ‡²ğŸ‡º' },
  { code: 'YT', name: 'Mayotte', flag: 'ğŸ‡¾ğŸ‡¹' },
  { code: 'MX', name: 'Mexico', flag: 'ğŸ‡²ğŸ‡½' },
  { code: 'FM', name: 'Micronesia', flag: 'ğŸ‡«ğŸ‡²' },
  { code: 'MD', name: 'Moldova', flag: 'ğŸ‡²ğŸ‡©' },
  { code: 'MC', name: 'Monaco', flag: 'ğŸ‡²ğŸ‡¨' },
  { code: 'MN', name: 'Mongolia', flag: 'ğŸ‡²ğŸ‡³' },
  { code: 'ME', name: 'Montenegro', flag: 'ğŸ‡²ğŸ‡ª' },
  { code: 'MS', name: 'Montserrat', flag: 'ğŸ‡²ğŸ‡¸' },
  { code: 'MA', name: 'Morocco', flag: 'ğŸ‡²ğŸ‡¦' },
  { code: 'MZ', name: 'Mozambique', flag: 'ğŸ‡²ğŸ‡¿' },
  { code: 'MM', name: 'Myanmar', flag: 'ğŸ‡²ğŸ‡²' },
  { code: 'NA', name: 'Namibia', flag: 'ğŸ‡³ğŸ‡¦' },
  { code: 'NR', name: 'Nauru', flag: 'ğŸ‡³ğŸ‡·' },
  { code: 'NP', name: 'Nepal', flag: 'ğŸ‡³ğŸ‡µ' },
  { code: 'NL', name: 'Netherlands', flag: 'ğŸ‡³ğŸ‡±' },
  { code: 'NC', name: 'New Caledonia', flag: 'ğŸ‡³ğŸ‡¨' },
  { code: 'NZ', name: 'New Zealand', flag: 'ğŸ‡³ğŸ‡¿' },
  { code: 'NI', name: 'Nicaragua', flag: 'ğŸ‡³ğŸ‡®' },
  { code: 'NE', name: 'Niger', flag: 'ğŸ‡³ğŸ‡ª' },
  { code: 'NG', name: 'Nigeria', flag: 'ğŸ‡³ğŸ‡¬' },
  { code: 'MK', name: 'North Macedonia', flag: 'ğŸ‡²ğŸ‡°' },
  { code: 'NO', name: 'Norway', flag: 'ğŸ‡³ğŸ‡´' },
  { code: 'OM', name: 'Oman', flag: 'ğŸ‡´ğŸ‡²' },
  { code: 'PK', name: 'Pakistan', flag: 'ğŸ‡µğŸ‡°' },
  { code: 'PW', name: 'Palau', flag: 'ğŸ‡µğŸ‡¼' },
  { code: 'PS', name: 'Palestine', flag: 'ğŸ‡µğŸ‡¸' },
  { code: 'PA', name: 'Panama', flag: 'ğŸ‡µğŸ‡¦' },
  { code: 'PG', name: 'Papua New Guinea', flag: 'ğŸ‡µğŸ‡¬' },
  { code: 'PY', name: 'Paraguay', flag: 'ğŸ‡µğŸ‡¾' },
  { code: 'PE', name: 'Peru', flag: 'ğŸ‡µğŸ‡ª' },
  { code: 'PH', name: 'Philippines', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'PL', name: 'Poland', flag: 'ğŸ‡µğŸ‡±' },
  { code: 'PT', name: 'Portugal', flag: 'ğŸ‡µğŸ‡¹' },
  { code: 'QA', name: 'Qatar', flag: 'ğŸ‡¶ğŸ‡¦' },
  { code: 'RO', name: 'Romania', flag: 'ğŸ‡·ğŸ‡´' },
  { code: 'RU', name: 'Russia', flag: 'ğŸ‡·ğŸ‡º' },
  { code: 'RW', name: 'Rwanda', flag: 'ğŸ‡·ğŸ‡¼' },
  { code: 'KN', name: 'Saint Kitts and Nevis', flag: 'ğŸ‡°ğŸ‡³' },
  { code: 'LC', name: 'Saint Lucia', flag: 'ğŸ‡±ğŸ‡¨' },
  { code: 'VC', name: 'Saint Vincent and the Grenadines', flag: 'ğŸ‡»ğŸ‡¨' },
  { code: 'WS', name: 'Samoa', flag: 'ğŸ‡¼ğŸ‡¸' },
  { code: 'SM', name: 'San Marino', flag: 'ğŸ‡¸ğŸ‡²' },
  { code: 'ST', name: 'Sao Tome and Principe', flag: 'ğŸ‡¸ğŸ‡¹' },
  { code: 'SA', name: 'Saudi Arabia', flag: 'ğŸ‡¸ğŸ‡¦' },
  { code: 'SN', name: 'Senegal', flag: 'ğŸ‡¸ğŸ‡³' },
  { code: 'RS', name: 'Serbia', flag: 'ğŸ‡·ğŸ‡¸' },
  { code: 'SC', name: 'Seychelles', flag: 'ğŸ‡¸ğŸ‡¨' },
  { code: 'SL', name: 'Sierra Leone', flag: 'ğŸ‡¸ğŸ‡±' },
  { code: 'SG', name: 'Singapore', flag: 'ğŸ‡¸ğŸ‡¬' },
  { code: 'SK', name: 'Slovakia', flag: 'ğŸ‡¸ğŸ‡°' },
  { code: 'SI', name: 'Slovenia', flag: 'ğŸ‡¸ğŸ‡®' },
  { code: 'SB', name: 'Solomon Islands', flag: 'ğŸ‡¸ğŸ‡§' },
  { code: 'SO', name: 'Somalia', flag: 'ğŸ‡¸ğŸ‡´' },
  { code: 'ZA', name: 'South Africa', flag: 'ğŸ‡¿ğŸ‡¦' },
  { code: 'SS', name: 'South Sudan', flag: 'ğŸ‡¸ğŸ‡¸' },
  { code: 'ES', name: 'Spain', flag: 'ğŸ‡ªğŸ‡¸' },
  { code: 'LK', name: 'Sri Lanka', flag: 'ğŸ‡±ğŸ‡°' },
  { code: 'SD', name: 'Sudan', flag: 'ğŸ‡¸ğŸ‡©' },
  { code: 'SR', name: 'Suriname', flag: 'ğŸ‡¸ğŸ‡·' },
  { code: 'SE', name: 'Sweden', flag: 'ğŸ‡¸ğŸ‡ª' },
  { code: 'CH', name: 'Switzerland', flag: 'ğŸ‡¨ğŸ‡­' },
  { code: 'SY', name: 'Syria', flag: 'ğŸ‡¸ğŸ‡¾' },
  { code: 'TW', name: 'Taiwan', flag: 'ğŸ‡¹ğŸ‡¼' },
  { code: 'TJ', name: 'Tajikistan', flag: 'ğŸ‡¹ğŸ‡¯' },
  { code: 'TZ', name: 'Tanzania', flag: 'ğŸ‡¹ğŸ‡¿' },
  { code: 'TH', name: 'Thailand', flag: 'ğŸ‡¹ğŸ‡­' },
  { code: 'TL', name: 'Timor-Leste', flag: 'ğŸ‡¹ğŸ‡±' },
  { code: 'TG', name: 'Togo', flag: 'ğŸ‡¹ğŸ‡¬' },
  { code: 'TO', name: 'Tonga', flag: 'ğŸ‡¹ğŸ‡´' },
  { code: 'TT', name: 'Trinidad and Tobago', flag: 'ğŸ‡¹ğŸ‡¹' },
  { code: 'TN', name: 'Tunisia', flag: 'ğŸ‡¹ğŸ‡³' },
  { code: 'TR', name: 'Turkey', flag: 'ğŸ‡¹ğŸ‡·' },
  { code: 'TM', name: 'Turkmenistan', flag: 'ğŸ‡¹ğŸ‡²' },
  { code: 'TV', name: 'Tuvalu', flag: 'ğŸ‡¹ğŸ‡»' },
  { code: 'UG', name: 'Uganda', flag: 'ğŸ‡ºğŸ‡¬' },
  { code: 'UA', name: 'Ukraine', flag: 'ğŸ‡ºğŸ‡¦' },
  { code: 'AE', name: 'United Arab Emirates', flag: 'ğŸ‡¦ğŸ‡ª' },
  { code: 'GB', name: 'United Kingdom', flag: 'ğŸ‡¬ğŸ‡§' },
  { code: 'UM', name: 'United States Minor Outlying Islands', flag: 'ğŸ‡ºğŸ‡²' },
  { code: 'VI', name: 'United States Virgin Islands', flag: 'ğŸ‡»ğŸ‡®' },
  { code: 'UY', name: 'Uruguay', flag: 'ğŸ‡ºğŸ‡¾' },
  { code: 'UZ', name: 'Uzbekistan', flag: 'ğŸ‡ºğŸ‡¿' },
  { code: 'VU', name: 'Vanuatu', flag: 'ğŸ‡»ğŸ‡º' },
  { code: 'VA', name: 'Vatican City', flag: 'ğŸ‡»ğŸ‡¦' },
  { code: 'VE', name: 'Venezuela', flag: 'ğŸ‡»ğŸ‡ª' },
  { code: 'VN', name: 'Vietnam', flag: 'ğŸ‡»ğŸ‡³' },
  { code: 'WF', name: 'Wallis and Futuna', flag: 'ğŸ‡¼ğŸ‡«' },
  { code: 'EH', name: 'Western Sahara', flag: 'ğŸ‡ªğŸ‡­' },
  { code: 'YE', name: 'Yemen', flag: 'ğŸ‡¾ğŸ‡ª' },
  { code: 'ZM', name: 'Zambia', flag: 'ğŸ‡¿ğŸ‡²' },
  { code: 'ZW', name: 'Zimbabwe', flag: 'ğŸ‡¿ğŸ‡¼' },
];

interface TargetingModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (targeting: {
    geoTargeting: { locations: Array<{ code: string; name: string; flag: string; url: string }> };
    iosUrl: string;
    androidUrl: string;
  }) => void;
  initialValues?: {
    geoTargeting?: { locations: Array<{ code: string; name: string; flag: string; url?: string }> };
    iosUrl?: string;
    androidUrl?: string;
  };
  workspaceId: string;
}

// Simple tooltip component
function ProTooltip({
  children,
  content
}: {
  children: React.ReactNode;
  content: { text: string; link: string; linkText: string }
}) {
  const [show, setShow] = useState(false);
  const [position, setPosition] = useState({ top: 0, left: 0 });
  const triggerRef = useRef<HTMLDivElement>(null);

  const handleMouseEnter = () => {
    if (triggerRef.current) {
      const rect = triggerRef.current.getBoundingClientRect();
      setPosition({
        top: rect.top - 10, // Position above with some offset
        left: rect.left + rect.width / 2
      });
      setShow(true);
    }
  };

  return (
    <>
      <div
        ref={triggerRef}
        onMouseEnter={handleMouseEnter}
        onMouseLeave={() => setShow(false)}
        className="inline-block"
      >
        {children}
      </div>
      {show && (
        <div
          className="fixed z-[100] transform -translate-x-1/2 -translate-y-full"
          style={{
            top: `${position.top}px`,
            left: `${position.left}px`,
            maxWidth: '320px'
          }}
        >
          <div className="bg-white border border-gray-200 rounded-lg shadow-lg px-3 py-2 text-sm text-gray-700 text-center">
            <p>{content.text}</p>
            <a
              href={content.link}
              target="_blank"
              rel="noopener noreferrer"
              className="text-gray-500 underline hover:text-gray-700 mt-1 inline-block"
            >
              {content.linkText}
            </a>
            <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full">
              <div className="w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-t-[5px] border-t-white"></div>
            </div>
          </div>
        </div>
      )}
    </>
  );
}

export function TargetingModal({
  isOpen,
  onClose,
  onSave,
  initialValues = {},
  workspaceId,
}: TargetingModalProps) {
  const [geoLocations, setGeoLocations] = useState<Array<{ code: string; name: string; flag: string; url: string }>>(
    initialValues.geoTargeting?.locations || []
  );
  const [iosUrl, setIosUrl] = useState(initialValues.iosUrl || '');
  const [androidUrl, setAndroidUrl] = useState(initialValues.androidUrl || '');
  const [showGeoUpgrade, setShowGeoUpgrade] = useState(false);
  const [showIosUpgrade, setShowIosUpgrade] = useState(false);
  const [showAndroidUpgrade, setShowAndroidUpgrade] = useState(false);
  const geoUpgradeRef = useRef<HTMLDivElement>(null);
  const iosUpgradeRef = useRef<HTMLDivElement>(null);
  const androidUpgradeRef = useRef<HTMLDivElement>(null);
  const ignoreNextClick = useRef(false);
  const prevIsOpen = useRef(false);
  const router = useRouter();
  const params = useParams();
  const workspaceSlug = params?.workspace as string || workspaceId;

  // Check feature gates
  const { checkFeature } = useFeatureGate(workspaceId);
  const geoTargetingFeature = checkFeature('geo_targeting');
  const deviceTargetingFeature = checkFeature('device_targeting');

  // Reset values only when modal opens (not on every render)
  useEffect(() => {
    // Only reset when modal transitions from closed to open
    if (isOpen && !prevIsOpen.current) {
      setGeoLocations(initialValues.geoTargeting?.locations?.map(loc => ({ ...loc, url: loc.url || '' })) || []);
      setIosUrl(initialValues.iosUrl || '');
      setAndroidUrl(initialValues.androidUrl || '');
      setShowGeoUpgrade(false);
      setShowIosUpgrade(false);
      setShowAndroidUpgrade(false);
    }
    prevIsOpen.current = isOpen;
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen]); // Only depend on isOpen to prevent unwanted re-runs

  // Close dropdowns when clicking outside - TEMPORARILY DISABLED FOR DEBUGGING
  // useEffect(() => {
  //   const handleClickOutside = (event: MouseEvent) => {
  //     // Skip if we should ignore this click
  //     if (ignoreNextClick.current) {
  //       ignoreNextClick.current = false;
  //       return;
  //     }

  //     const target = event.target as Node;

  //     // Handle location picker
  //     if (showLocationPicker && dropdownRef.current && !dropdownRef.current.contains(target)) {
  //       setShowLocationPicker(false);
  //       setLocationSearch('');
  //     }

  //     // Handle geo upgrade
  //     if (showGeoUpgrade && geoUpgradeRef.current && !geoUpgradeRef.current.contains(target)) {
  //       setShowGeoUpgrade(false);
  //     }

  //     // Handle iOS upgrade
  //     if (showIosUpgrade && iosUpgradeRef.current && !iosUpgradeRef.current.contains(target)) {
  //       setShowIosUpgrade(false);
  //     }

  //     // Handle Android upgrade
  //     if (showAndroidUpgrade && androidUpgradeRef.current && !androidUpgradeRef.current.contains(target)) {
  //       setShowAndroidUpgrade(false);
  //     }
  //   };

  //   // Always add the listener when modal is open
  //   if (isOpen) {
  //     document.addEventListener('click', handleClickOutside);
  //     return () => {
  //       document.removeEventListener('click', handleClickOutside);
  //     };
  //   }
  // }, [isOpen, showLocationPicker, showGeoUpgrade, showIosUpgrade, showAndroidUpgrade]);

  const handleAddLocation = (country: { code: string; name: string; flag: string }) => {
    setGeoLocations([...geoLocations, { ...country, url: '' }]);
    setShowLocationPicker(false);
    setLocationSearch('');
  };

  const handleRemoveLocation = (countryCode: string) => {
    setGeoLocations(geoLocations.filter(loc => loc.code !== countryCode));
  };

  const handleLocationUrlChange = (countryCode: string, url: string) => {
    setGeoLocations(geoLocations.map(loc =>
      loc.code === countryCode ? { ...loc, url } : loc
    ));
  };

  const handleSave = () => {
    onSave({
      geoTargeting: { locations: geoLocations },
      iosUrl,
      androidUrl,
    });
    onClose();
  };

  // Check if any targeting is configured (geo locations must have URLs)
  const hasValidGeoTargeting = geoLocations.length > 0 && geoLocations.every(loc => loc.url.trim() !== '');
  const hasTargeting = hasValidGeoTargeting || iosUrl.trim() !== '' || androidUrl.trim() !== '';

  const handleCancel = () => {
    // Reset to initial values
    setGeoLocations(initialValues.geoTargeting?.locations?.map(loc => ({ ...loc, url: loc.url || '' })) || []);
    setIosUrl(initialValues.iosUrl || '');
    setAndroidUrl(initialValues.androidUrl || '');
    setShowGeoUpgrade(false);
    setShowIosUpgrade(false);
    setShowAndroidUpgrade(false);
    onClose();
  };

  const handleAddLocationClick = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();

    // Set flag to ignore the next document click
    ignoreNextClick.current = true;

    if (!geoTargetingFeature.enabled) {
      setShowGeoUpgrade(true);
    } else {
      // Add a default location (United States) with empty URL
      const defaultCountry = COUNTRIES[0]; // United States is first
      if (!geoLocations.some(loc => loc.code === defaultCountry.code)) {
        setGeoLocations([...geoLocations, { ...defaultCountry, url: '' }]);
      } else {
        // Find first country not already selected
        const availableCountry = COUNTRIES.find(c => !geoLocations.some(loc => loc.code === c.code));
        if (availableCountry) {
          setGeoLocations([...geoLocations, { ...availableCountry, url: '' }]);
        }
      }
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[70] flex items-center justify-center">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/20 backdrop-blur-sm"
        onClick={handleCancel}
      />

      {/* Modal */}
      <div className="relative w-full max-w-lg bg-white rounded-xl shadow-2xl mx-4">
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200">
          <h2 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
            Targeting
            <span className="px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded">
              G
            </span>
          </h2>
          <button
            onClick={handleCancel}
            className="p-1 hover:bg-gray-100 rounded-md transition-colors"
            aria-label="Close"
          >
            <X className="h-5 w-5 text-gray-500" />
          </button>
        </div>

        {/* Content */}
        <div className="p-6 space-y-6">
          {/* Geo Targeting */}
          <div>
            <div className="flex items-center gap-2 mb-3">
              <Label className="text-sm font-medium text-gray-900">
                Geo Targeting
              </Label>
              <ProTooltip
                content={{
                  text: 'Redirect your users to different links based on their location.',
                  link: 'https://isla.so/help/article/geo-targeting',
                  linkText: 'Learn more about geo targeting.'
                }}
              >
                <button
                  type="button"
                  className="inline-flex items-center gap-1 px-1.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded cursor-help focus:outline-none"
                >
                  <Crown className="h-3 w-3" />
                  PRO
                </button>
              </ProTooltip>
            </div>

            {/* Location Input */}
            <div className="space-y-2">
              {/* Selected countries */}
              {geoLocations.map((location, index) => (
                <div key={location.code} className="flex items-center gap-2">
                  {/* Country dropdown */}
                  <div className="relative w-44">
                    <select
                      value={location.code}
                      onChange={(e) => {
                        const newCountry = COUNTRIES.find(c => c.code === e.target.value);
                        if (newCountry) {
                          const newLocations = [...geoLocations];
                          newLocations[index] = { ...newCountry, url: location.url };
                          setGeoLocations(newLocations);
                        }
                      }}
                      className="w-full appearance-none px-3 py-2 pr-8 text-sm bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 cursor-pointer"
                    >
                      {COUNTRIES.filter(c =>
                        !geoLocations.some(loc => loc.code === c.code) || c.code === location.code
                      ).map(country => (
                        <option key={country.code} value={country.code}>
                          {country.flag} {country.name}
                        </option>
                      ))}
                    </select>
                    <ChevronDown className="absolute right-2 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none" />
                  </div>

                  {/* URL input */}
                  <input
                    type="url"
                    placeholder="https://example.com"
                    value={location.url}
                    onChange={(e) => handleLocationUrlChange(location.code, e.target.value)}
                    className="flex-1 px-3 py-2 text-sm placeholder-gray-400 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"
                  />

                  {/* Delete button */}
                  <button
                    onClick={() => handleRemoveLocation(location.code)}
                    className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                  >
                    <X className="h-4 w-4 text-gray-500" />
                  </button>
                </div>
              ))}

              {/* Add location button */}
              <div className="relative" ref={geoUpgradeRef}>
                <button
                  onClick={handleAddLocationClick}
                  className="w-full px-3 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-colors text-center font-medium"
                >
                  Add location
                </button>

                {/* Geo Targeting Upgrade Dropdown */}
                {showGeoUpgrade && (
                  <div
                    className="absolute top-full left-0 right-0 mt-2 p-4 bg-white rounded-lg border border-gray-200 shadow-lg z-50"
                    onClick={(e) => e.stopPropagation()}
                  >
                    <p className="text-sm text-gray-600 text-center mb-4">
                      You can only use Geo Targeting on a Pro plan and above. Upgrade to Pro to continue.
                    </p>
                    <Button
                      className="w-full bg-gray-900 hover:bg-gray-800 text-white"
                      onClick={() => router.push(`/${workspaceSlug}/settings/billing?upgrade=true&reason=geo_targeting`)}
                    >
                      Upgrade to Pro
                    </Button>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* iOS Targeting */}
          <div>
            <div className="flex items-center gap-2 mb-3">
              <Label className="text-sm font-medium text-gray-900">
                iOS Targeting
              </Label>
              <ProTooltip
                content={{
                  text: 'Redirect your iOS users to a different link.',
                  link: 'https://isla.so/help/article/device-targeting',
                  linkText: 'Learn more about device targeting.'
                }}
              >
                <button
                  type="button"
                  className="inline-flex items-center gap-1 px-1.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded cursor-help focus:outline-none"
                >
                  <Crown className="h-3 w-3" />
                  PRO
                </button>
              </ProTooltip>
            </div>
            <div className="relative" ref={iosUpgradeRef}>
              <input
                type="url"
                placeholder="https://apps.apple.com/app/1611158928"
                value={iosUrl}
                onChange={(e) => setIosUrl(e.target.value)}
                onFocus={() => {
                  if (!deviceTargetingFeature.enabled) {
                    setShowIosUpgrade(true);
                  }
                }}
                className="w-full px-3 py-2 text-sm placeholder-gray-400 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"
              />

              {/* iOS Targeting Upgrade Dropdown */}
              {showIosUpgrade && (
                <div className="absolute top-full left-0 right-0 mt-2 p-4 bg-white rounded-lg border border-gray-200 shadow-lg z-50">
                  <p className="text-sm text-gray-600 text-center mb-4">
                    You can only use iOS Targeting on a Pro plan and above. Upgrade to Pro to continue.
                  </p>
                  <Button
                    className="w-full bg-gray-900 hover:bg-gray-800 text-white"
                    onClick={() => router.push(`/${workspaceSlug}/settings/billing?upgrade=true&reason=device_targeting`)}
                  >
                    Upgrade to Pro
                  </Button>
                </div>
              )}
            </div>
          </div>

          {/* Android Targeting */}
          <div>
            <div className="flex items-center gap-2 mb-3">
              <Label className="text-sm font-medium text-gray-900">
                Android Targeting
              </Label>
              <ProTooltip
                content={{
                  text: 'Redirect your Android users to a different link.',
                  link: 'https://isla.so/help/article/device-targeting',
                  linkText: 'Learn more about device targeting.'
                }}
              >
                <button
                  type="button"
                  className="inline-flex items-center gap-1 px-1.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded cursor-help focus:outline-none"
                >
                  <Crown className="h-3 w-3" />
                  PRO
                </button>
              </ProTooltip>
            </div>
            <div className="relative" ref={androidUpgradeRef}>
              <input
                type="url"
                placeholder="https://play.google.com/store/apps/details?id=com.disney.disneyplus"
                value={androidUrl}
                onChange={(e) => setAndroidUrl(e.target.value)}
                onFocus={() => {
                  if (!deviceTargetingFeature.enabled) {
                    setShowAndroidUpgrade(true);
                  }
                }}
                className="w-full px-3 py-2 text-sm placeholder-gray-400 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"
              />

              {/* Android Targeting Upgrade Dropdown */}
              {showAndroidUpgrade && (
                <div className="absolute top-full left-0 right-0 mt-2 p-4 bg-white rounded-lg border border-gray-200 shadow-lg z-50">
                  <p className="text-sm text-gray-600 text-center mb-4">
                    You can only use Android Targeting on a Pro plan and above. Upgrade to Pro to continue.
                  </p>
                  <Button
                    className="w-full bg-gray-900 hover:bg-gray-800 text-white"
                    onClick={() => router.push(`/${workspaceSlug}/settings/billing?upgrade=true&reason=device_targeting`)}
                  >
                    Upgrade to Pro
                  </Button>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200">
          <Button
            variant="outline"
            onClick={handleCancel}
            className="h-9 px-4"
          >
            Cancel
          </Button>
          <Button
            onClick={handleSave}
            disabled={!hasTargeting}
            className="h-9 px-4 bg-black hover:bg-gray-800 text-white disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Add targeting
          </Button>
        </div>
      </div>
    </div>
  );
}