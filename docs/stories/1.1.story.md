# Story 1.1: Complete Links Page Implementation

## Status
Approved

## Implementation Notes
**IMPORTANT**: This is a comprehensive MVP implementation including ALL Epic 1 features.
- All 10 sub-stories must be implemented together
- Build on existing page structure at `/app/[workspace]/links/page.tsx`
- Integrate with existing workspace layout
- Real-time updates required (no page refresh needed)

## Story
**As a** workspace user,
**I want** a complete links management page with all essential features,
**so that** I can create, manage, analyze, and organize all my shortened links in one comprehensive interface

## Acceptance Criteria

### Core Layout & Navigation (Story 1.1)
1. Three-panel layout (icon sidebar, nav panel, main content) matching existing workspace layout
2. Empty state shows "No links yet" message with "Create link" and "Learn more" buttons
3. Header with page title "Links"
4. Responsive on mobile with proper layout adjustments

### Create Link Modal (Story 1.2)
5. Modal opens on "Create link" button click with proper focus trap and ESC to close
6. All required fields implemented:
   - Destination URL (required, with validation)
   - Short link with domain selector and random slug generation
   - Tags selector with autocomplete
   - Comments field
   - Folder selector
   - QR code preview (auto-generated)
   - Custom link preview
7. Bottom tabs for additional options (UTM, Targeting, Password, Expiration)
8. "Create link" action button with form validation
9. Drafts functionality to save incomplete links

### Display Links Views (Story 1.3)
10. Card view displays:
    - Favicon (cached for performance)
    - Short link with copy button
    - Destination domain
    - Timestamp (relative time)
    - Click count (real-time updates)
    - Three-dot menu (Edit, Duplicate, QR Code, Archive, Delete)
11. Table view shows same information in row format with sortable columns
12. Toggle between views via Display menu with preference persistence
13. Virtual scrolling for performance with 1000+ links

### Edit Functionality (Story 1.4)
14. Click on link opens edit modal with all fields pre-populated
15. All fields editable except short URL (slug)
16. Save changes with validation and conflict handling
17. Show "Created by" attribution with user avatar and name

### Search and Filtering (Story 1.5)
18. Search by short link or destination URL with debouncing
19. Real-time filtering as user types (client-side for speed)
20. Clear search button with keyboard shortcut (Cmd+K)
21. No results state with helpful suggestions

### Folder Navigation (Story 1.6)
22. Dropdown shows all folders with search functionality
23. "View All" navigates to folders page
24. Create new folder option inline
25. Show current folder selection with breadcrumb navigation

### Display Options Menu (Story 1.7)
26. Cards/Rows toggle with smooth transition
27. Sort options (Date created, Total clicks, Last clicked, Alphabetical)
28. Show archived links toggle
29. Column visibility checkboxes for table view
30. Settings persist across sessions in localStorage

### Import/Export Functionality (Story 1.8)
31. Import from CSV with field mapping UI
32. Import from Bitly, Rebrandly, Short.io (UI placeholder for now)
33. Export selected links as CSV
34. Progress indicator for import with error handling
35. Background job for large imports (>100 links)

### Multi-Select and Bulk Operations (Story 1.9)
36. Checkboxes appear on hover with smooth animation
37. Select all checkbox with indeterminate state
38. Shift-click for range selection
39. Bulk actions toolbar (Delete, Archive, Move, Tag)
40. Keyboard shortcuts (Cmd+A for select all, Delete key for delete)

### Virtual Scrolling/Pagination (Story 1.10)
41. Load 50 items initially
42. Load more as user scrolls with Intersection Observer
43. "Viewing X-Y of Z" indicator
44. Smooth scrolling performance with react-window
45. Previous/Next navigation for keyboard users

## Dev Notes

### Previous Story Insights [Source: Epic 0.5 completion]
- Workspace layout established with three-panel structure
- Icon sidebar: #e5e5e5 background
- Navigation panel: #F5F5F5 background
- Main content: White floating panel with rounded corners
- Authentication and workspace routing already implemented
- tRPC integration patterns established with proper error handling
- Getting Started widget successfully implemented for onboarding

### Tech Stack [Source: architecture/tech-stack.md]
- **Frontend Framework**: Next.js 14.2+ with App Router
- **UI Components**: shadcn/ui (latest) - already configured
- **State Management**: Zustand 4.5+ for client state
- **Data Fetching**: TanStack Query 5.18+ with tRPC
- **CSS**: Tailwind CSS 3.4+
- **TypeScript**: 5.3+ for type safety
- **Icons**: Lucide React 0.32+
- **QR Generator**: qrcode 1.5+
- **Virtualization**: react-window for performance
- **Form Validation**: Zod 3.22+ with react-hook-form 7.49+
- **Time Library**: date-fns 3.3+ for timestamp formatting

### Database Schema [Source: prisma/schema.prisma]
```typescript
model links {
  id                      String     @id @db.Uuid
  workspace_id            String     @db.Uuid
  folder_id               String?    @db.Uuid
  campaign_id             String?    @db.Uuid
  slug                    String     @unique
  url                     String
  title                   String?
  description             String?
  image                   String?
  favicon                 String?
  password                String?
  expires_at              DateTime?  @db.Timestamptz(6)
  is_active               Boolean    @default(true)
  click_limit             Int?
  click_count             Int        @default(0)
  last_clicked_at         DateTime?  @db.Timestamptz(6)
  utm_source              String?
  utm_medium              String?
  utm_campaign            String?
  utm_term                String?
  utm_content             String?
  ios_url                 String?
  android_url             String?
  enable_geolocation      Boolean    @default(false)
  enable_device_targeting Boolean    @default(false)
  created_at              DateTime   @default(now()) @db.Timestamptz(6)
  updated_at              DateTime   @db.Timestamptz(6)
  created_by              String     @db.Uuid
  tags                    String[]   @default([])
  deleted_at              DateTime?  @db.Timestamptz(6)
}
```

### File Locations [Source: existing structure]
- **Page Component**: `/app/[workspace]/links/page.tsx` (already exists)
- **Layout**: `/app/[workspace]/layout.tsx` (already exists)
- **Components Directory**: `/app/[workspace]/links/components/`
  - `LinkCard.tsx` - Individual link card component
  - `LinkTable.tsx` - Table view component
  - `CreateLinkModal.tsx` - Create/Edit modal
  - `LinkActions.tsx` - Three-dot menu actions
  - `SearchFilter.tsx` - Search and filter bar
  - `DisplayOptions.tsx` - Display options menu
  - `ImportExport.tsx` - Import/export functionality
  - `EmptyState.tsx` - No links state
  - `BulkActions.tsx` - Multi-select toolbar
- **Hooks**: `/hooks/`
  - `useLinks.ts` - Links data fetching and mutations
  - `useVirtualScroll.ts` - Virtual scrolling logic
  - `useMultiSelect.ts` - Selection state management
- **Utils**: `/lib/`
  - `link-utils.ts` - URL validation, slug generation
  - `qr-generator.ts` - QR code generation
  - `csv-parser.ts` - CSV import/export
- **tRPC Router**: `/app/server/routers/links.ts`

### Component Patterns [Source: existing codebase]
- Client components: Use "use client" directive
- Server components for initial data fetching
- tRPC hooks: `trpc.links.list.useQuery()`, `trpc.links.create.useMutation()`
- Auth context: `useAuth()` hook for user info
- Router: `useRouter()` and `useSearchParams()` from next/navigation
- Loading states: Consistent skeleton components
- Error boundaries for resilience

### API Endpoints (tRPC procedures) [Source: architecture patterns]
```typescript
// Links router procedures
links.list - Get paginated links with filters
links.create - Create new link
links.update - Update existing link
links.delete - Delete link(s)
links.archive - Archive link(s)
links.duplicate - Duplicate a link
links.import - Import links from CSV
links.export - Export links to CSV
links.bulkAction - Perform bulk operations
links.getBySlug - Get single link details
```

### Performance Considerations
- Use react-window for virtualizing link lists (activate when >100 links)
- Implement cursor-based pagination for API calls (50-100 links initial load)
- Cache favicons using Next.js Image component
- Debounce search input (300ms)
- Optimistic UI updates for better perceived performance
- Use Suspense boundaries for async components
- Lazy load modals and heavy components

### Real-time Updates Strategy
- Use SWR with 5-second polling interval for click counts
- Implement optimistic updates for immediate UI feedback
- Use tRPC subscriptions or polling for live data
- WebSocket connection for critical real-time features (optional enhancement)
- Cache invalidation on mutations to trigger refetch

### Testing Standards [Source: architecture/testing-strategy.md]
- Test files location: `__tests__/` subdirectory within component folder
- Use Vitest for unit tests
- Test coverage requirements:
  - Link CRUD operations
  - Search and filtering
  - Multi-select functionality
  - Import/export edge cases
  - Virtual scrolling behavior
- Mock tRPC procedures for isolation
- Test responsive breakpoints

## Tasks / Subtasks

### 1. Setup Page Structure and Empty State (AC: 1-4)
- [ ] Update `/app/[workspace]/links/page.tsx` with proper layout structure
- [ ] Create `EmptyState.tsx` component with call-to-action buttons
- [ ] Ensure responsive design with mobile breakpoints
- [ ] Add page header with title and primary actions

### 2. Implement Create/Edit Link Modal (AC: 5-9, 14-17)
- [x] Create `CreateLinkModal.tsx` with all form fields
- [ ] Implement URL validation with Zod schema
- [ ] Add slug generation logic with uniqueness check
- [ ] Integrate QR code generation with qrcode library
- [ ] Add folder selector with search functionality
- [ ] Implement tags autocomplete
- [ ] Add UTM parameter fields in collapsible section
- [ ] Add targeting options (device, geo)
- [ ] Add password protection option
- [ ] Add expiration date picker
- [x] Implement draft saving functionality
- [ ] Add edit mode with pre-population
- [ ] Handle save conflicts and errors

### 3. Build Link Display Components (AC: 10-13)
- [ ] Create `LinkCard.tsx` component with all required elements
- [ ] Create `LinkTable.tsx` with sortable columns
- [ ] Implement favicon fetching and caching
- [ ] Add real-time click count updates via WebSocket/polling
- [ ] Create three-dot menu with all actions
- [ ] Add copy-to-clipboard functionality for short links
- [ ] Implement view toggle with animation

### 4. Add Search and Filtering (AC: 18-21)
- [ ] Create `SearchFilter.tsx` component
- [ ] Implement debounced search logic
- [ ] Add client-side filtering for performance
- [ ] Create no-results state component
- [ ] Add keyboard shortcuts (Cmd+K)

### 5. Implement Folder Navigation (AC: 22-25)
- [ ] Create folder dropdown component
- [ ] Add folder search within dropdown
- [ ] Implement inline folder creation
- [ ] Add breadcrumb navigation
- [ ] Connect to folders data model

### 6. Build Display Options Menu (AC: 26-30)
- [ ] Create `DisplayOptions.tsx` dropdown menu
- [ ] Add view toggle (cards/table)
- [ ] Implement sort options with persistence
- [ ] Add archived links toggle
- [ ] Create column visibility controls for table
- [ ] Store preferences in localStorage

### 7. Implement Import/Export (AC: 31-35)
- [ ] Create `ImportExport.tsx` component
- [ ] Build CSV parser with field mapping UI
- [ ] Add import progress indicator
- [ ] Implement export to CSV functionality
- [ ] Create placeholder UI for third-party imports
- [ ] Add background job handling for large imports

### 8. Add Multi-Select and Bulk Operations (AC: 36-40)
- [ ] Create `useMultiSelect.ts` hook
- [ ] Add checkbox UI with hover states
- [ ] Implement select all with indeterminate state
- [ ] Add shift-click range selection
- [ ] Create `BulkActions.tsx` toolbar
- [ ] Add keyboard shortcuts
- [ ] Implement bulk operations (delete, archive, move, tag)

### 9. Implement Virtual Scrolling (AC: 41-45)
- [ ] Integrate react-window for virtualization
- [ ] Add Intersection Observer for infinite scroll
- [ ] Create pagination indicators
- [ ] Add keyboard navigation support
- [ ] Optimize performance for 1000+ links

### 10. Create tRPC Router and API Integration
- [ ] Create `/app/server/routers/links.ts` with all procedures
- [ ] Implement pagination with cursor
- [ ] Add filtering and sorting logic
- [ ] Create mutation procedures for CRUD operations
- [ ] Add bulk operation procedures
- [ ] Implement import/export endpoints
- [ ] Add proper error handling and validation

### 11. Add Unit Tests
- [ ] Test link creation with validation
- [ ] Test search and filtering logic
- [ ] Test multi-select functionality
- [ ] Test import/export edge cases
- [ ] Test virtual scrolling behavior
- [ ] Test responsive layouts
- [ ] Mock tRPC procedures properly

### 12. Integration and Polish
- [ ] Connect all components together
- [ ] Add loading skeletons
- [ ] Implement error boundaries
- [ ] Add success/error toasts
- [ ] Optimize bundle size with code splitting
- [ ] Performance testing with 1000+ links
- [ ] Cross-browser testing
- [ ] Mobile responsive testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial comprehensive story creation combining all Epic 1 sub-stories | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805 (James - Full Stack Developer)

### Debug Log References
- Fixed draft auto-save issue where drafts were saving without user changes
- Updated initialValues tracking in CreateLinkModal to include all form fields
- Improved comparison logic in useAutoSaveDraft hook to properly detect user changes
- Fixed React hydration mismatch by ensuring slug generation only happens on client side
- Used useRef to prevent multiple slug regenerations during re-renders
- Added proper initialization delay to prevent premature autosave triggers

### Completion Notes
- Draft auto-save functionality now only triggers when user makes actual changes to form fields
- Initial values (auto-generated slug, default domain, etc.) are properly tracked and excluded from triggering saves
- Fixed type mismatch between `slug` and `shortLink` in draft data interface
- Resolved hydration issues by moving random generation to client-side only
- Slug is now generated once per modal session and stored in ref to prevent regeneration

### File List
- Modified: /app/[workspace]/links/page.tsx
- Modified: /components/links/CreateLinkModal.tsx
- Modified: /hooks/useAutoSaveDraft.ts
- Created: /hooks/useDebounce.ts
- Created: /components/links/LinksFooter.tsx
- Created: /app/server/routers/linkDrafts.ts

## QA Results
_To be populated by QA agent_